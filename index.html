<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #f0f4f8 0%, #e0e7ef 100%);
            font-family: 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            color: #222;
        }
        .iframe-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 40px;
            gap: 12px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 49%;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.05);
            padding: 18px 10px 12px 10px;
            transition: box-shadow 0.2s;
        }
        .control-group:hover {
            box-shadow: 0 6px 18px rgba(0,0,0,0.11), 0 1.5px 4px rgba(0,0,0,0.08);
        }
        .iframe-wrapper {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 比例 */
            margin-bottom: 18px;
        }
        iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 12px;
            background: #e9eef3;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 0;
        }
        .status {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.08em;
            font-weight: 500;
            color: #3a7afe;
        }
        .ffmpeg-details {
            font-size: 0.98em;
            color: #666;
            background: #f5f7fa;
            border-radius: 8px;
            padding: 6px 12px;
            margin-bottom: 8px;
        }
        .controls {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: 36px;
        }
        button {
            background: linear-gradient(90deg, #3a7afe 0%, #4f8cff 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 12px 36px;
            font-size: 1.15em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(58,122,254,0.08);
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
        }
        button:hover {
            background: linear-gradient(90deg, #2e6be6 0%, #3a7afe 100%);
            box-shadow: 0 4px 16px rgba(58,122,254,0.13);
            transform: translateY(-2px) scale(1.03);
        }
        /* Switch 开关样式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 1px 4px rgba(0,0,0,0.10);
        }
        .switch input:checked + .slider {
            background-color: #3a7afe;
        }
        .switch input:checked + .slider:before {
            transform: translateX(20px);
        }
        @media (max-width: 900px) {
            .iframe-container {
                flex-direction: column;
                align-items: center;
                gap: 16px;
                width: 98%;
            }
            .control-group {
                width: 98%;
            }
        }
    </style>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
</head>
<body>
    <div class="iframe-container">
        <div class="control-group">
            <div style="font-size:1.25em;font-weight:600;color:#3a7afe;margin-bottom:10px;">光通信</div>
            <div class="iframe-wrapper">
                <iframe src="http://127.0.0.1:8889/stream1/"></iframe>
            </div>
            <div class="status">
                <p id="ffmpeg-status1" style="display:inline;">FFmpeg 状态: 未知</p>
                <span style="margin-left:24px;color:#faad14;font-weight:500;" id="device-status1">设备通信状态：未知</span>
            </div>
            <div class="ffmpeg-details">
                <p>分辨率: <span id="ffmpeg-resolution1">未知</span> | 码率: <span id="ffmpeg-bitrate1">未知</span> kbps</p>
            </div>
            <div style="display:flex;align-items:center;gap:18px;margin-top:10px;width:100%;justify-content:center;">
                <button style="width:240px;" onclick="startNegotiation()">自协商开始</button>
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                    <span class="switch">
                        <input type="checkbox" id="adaptive-switch">
                        <span class="slider"></span>
                    </span>
                    <span style="font-size:1em;color:#3a7afe;font-weight:500;">自适应开关</span>
                </label>
            </div>
        </div>
        <div class="control-group">
            <div style="font-size:1.25em;font-weight:600;color:#3a7afe;margin-bottom:10px;">声通信</div>
            <div class="iframe-wrapper">
                <iframe src="http://127.0.0.1:8889/stream2/"></iframe>
            </div>
            <div class="status">
                <p id="ffmpeg-status2" style="display:inline;">FFmpeg 状态: 未知</p>
                <span style="margin-left:24px;color:#faad14;font-weight:500;" id="handshake-status2">握手状态：未知</span>
            </div>
            <div class="ffmpeg-details">
                <p>分辨率: <span id="ffmpeg-resolution2">未知</span> | 码率: <span id="ffmpeg-bitrate2">未知</span> kbps</p>
            </div>
            <div style="display:flex;align-items:center;justify-content:center;margin-top:10px;width:100%;">
                <button style="width:240px;" onclick="startTransmission()">传输启动</button>
            </div>
        </div>
    </div>
    <div class="controls">
        <button onclick="shutdown()">关机</button>
    </div>
    <script>
        function sendToQtUDPInfoPortSuccess(message) {
            if (window.qt && window.qt.webChannelTransport) {
                new QWebChannel(window.qt.webChannelTransport, function(channel) {
                    channel.objects.udpPort.sendSuccess(JSON.stringify(message));
                });
            } else {
                alert('Qt WebChannel is not available.');
            }
        }

        function sendToQtUDPInfoPortFailure(message) {
            if (window.qt && window.qt.webChannelTransport) {
                new QWebChannel(window.qt.webChannelTransport, function(channel) {
                    channel.objects.udpPort.sendFailure(JSON.stringify(message));
                });
            } else {
                alert('Qt WebChannel is not available.');
            }
        }

        function startNegotiation() {
            const payload = {
                ip: '192.168.1.11',
                port: 10001,
                hex: '48 59 43 4C 11 03 09 1C 61'
            };
            fetch('http://127.0.0.1:6060/send_udp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    sendToQtUDPInfoPortSuccess(payload);
                } else {
                    sendToQtUDPInfoPortFailure(payload, '发送失败: ' + (data.msg || '未知错误'));
                }
            })
            .catch(err => {
                sendToQtUDPInfoPortFailure(payload, '请求异常: ' + err);
            });
        }

        function startTransmission() {
            const payload = {
                ip: '192.168.1.13',
                port: 10011,
                hex: '48 59 43 4C 13 03 09 BD A1'
            };
            fetch('http://127.0.0.1:6060/send_udp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    sendToQtUDPInfoPortSuccess(payload);
                } else {
                    sendToQtUDPInfoPortFailure(payload, '发送失败: ' + (data.msg || '未知错误'));
                }
            })
            .catch(err => {
                sendToQtUDPInfoPortFailure(payload, '请求异常: ' + err);
            });
        }

        function shutdown() {
            // 弹出确认提示（自定义标题和默认选项）
            if (!window.confirm('【关机确认】\n确定要关机吗？关机后需要重新上电重新启动设备。\n\n点击“确定”执行关机，点击“取消”放弃操作。')) {
                return;
            }
            // 用于收集两个请求的结果
            let results = [];
            let finished = 0;

            function handleResult(payload, status, msg) {
                results.push({
                    ip: payload.ip,
                    port: payload.port,
                    hex: payload.hex,
                    status: status,
                    msg: msg || ''
                });
                finished++;
                if (finished === 2) {
                    // 两次都完成后，统一上报
                    if (results.every(r => r.status === 'success')) {
                        sendToQtUDPInfoPortSuccess(results);
                    } else {
                        sendToQtUDPInfoPortFailure(results);
                    }
                }
            }

            const payload1 = {
                ip: '192.168.1.11',
                port: 10001,
                hex: '48 59 43 4C 10 05 09 4E 01'
            };
            fetch('http://127.0.0.1:6060/send_udp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload1)
            })
            .then(response => response.json())
            .then(data => {
                handleResult(payload1, data.status, data.msg);
            })
            .catch(err => {
                handleResult(payload1, 'error', err);
            });

            const payload2 = {
                ip: '192.168.1.13',
                port: 10011,
                hex: '48 59 43 4C 10 05 09 4E 01'
            };
            fetch('http://127.0.0.1:6060/send_udp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload2)
            })
            .then(response => response.json())
            .then(data => {
                handleResult(payload2, data.status, data.msg);
            })
            .catch(err => {
                handleResult(payload2, 'error', err);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const adaptiveSwitch = document.getElementById('adaptive-switch');
            if (adaptiveSwitch) {
                adaptiveSwitch.addEventListener('change', function() {
                    const isChecked = adaptiveSwitch.checked;
                    const payload = {
                        ip: '192.168.1.11',
                        port: 10001,
                        hex: isChecked
                            ? '48 59 43 4C 11 04 0A 00 D1 F8'
                            : '48 59 43 4C 11 04 0A 01 10 38'
                    };
                    fetch('http://127.0.0.1:6060/send_udp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            sendToQtUDPInfoPortSuccess(payload);
                        } else {
                            sendToQtUDPInfoPortFailure(payload, '发送失败: ' + (data.msg || '未知错误'));
                        }
                    })
                    .catch(err => {
                        sendToQtUDPInfoPortFailure(payload, '请求异常: ' + err);
                    });
                });
            }
        });

        function updateFFmpegStatus() {
            fetch('http://127.0.0.1:6060/ffmpeg_status')
                .then(response => response.json())
                .then(data => {
                    // 更新左侧
                    const status1 = data.ffmpeg_process1 === 'running' ? '运行中' : '已停止';
                    document.getElementById('ffmpeg-status1').textContent = 'FFmpeg 状态: ' + status1;
                    // 更新右侧
                    const status2 = data.ffmpeg_process2 === 'running' ? '运行中' : '已停止';
                    document.getElementById('ffmpeg-status2').textContent = 'FFmpeg 状态: ' + status2;
                })
                .catch(() => {
                    document.getElementById('ffmpeg-status1').textContent = 'FFmpeg 状态: 未知';
                    document.getElementById('ffmpeg-status2').textContent = 'FFmpeg 状态: 未知';
                });
        }

        // 记录上次的码率
        let lastBitrate1 = null;
        let lastBitrate2 = null;

        function updateDeviceStatus() {
            fetch('http://127.0.0.1:6060/status_feedback')
                .then(response => response.json())
                .then(data => {
                    // 设备通信状态（左侧）
                    document.getElementById('device-status1').textContent = '设备通信状态：' + data.comm_status_1_str;
                    // 左侧码率
                    document.getElementById('ffmpeg-bitrate1').textContent = data.bitrate_1_value;
                    // 分辨率1
                    if (data.resolution_1 && typeof data.resolution_1.width === 'number' && typeof data.resolution_1.height === 'number') {
                        if (data.resolution_1.width === -1 && data.resolution_1.height === -1) {
                            document.getElementById('ffmpeg-resolution1').textContent = '未知';
                        } else {
                            document.getElementById('ffmpeg-resolution1').textContent = data.resolution_1.width + '×' + data.resolution_1.height;
                        }
                    } else {
                        document.getElementById('ffmpeg-resolution1').textContent = '未知';
                    }
                    // 检查左侧码率变化，自动重启ffmpeg_process1
                    if (lastBitrate1 !== null && data.bitrate_1_value !== lastBitrate1) {
                        fetch('http://127.0.0.1:6060/restart_ffmpeg', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ target: 'ffmpeg_process1' })
                        });
                    }
                    lastBitrate1 = data.bitrate_1_value;

                    // 握手状态（右侧）
                    document.getElementById('handshake-status2').textContent = '握手状态：' + data.comm_status_2_str;
                    // 右侧码率
                    document.getElementById('ffmpeg-bitrate2').textContent = data.bitrate_2_value;
                    // 分辨率2
                    if (data.resolution_2 && typeof data.resolution_2.width === 'number' && typeof data.resolution_2.height === 'number') {
                        if (data.resolution_2.width === -1 && data.resolution_2.height === -1) {
                            document.getElementById('ffmpeg-resolution2').textContent = '未知';
                        } else {
                            document.getElementById('ffmpeg-resolution2').textContent = data.resolution_2.width + '×' + data.resolution_2.height;
                        }
                    } else {
                        document.getElementById('ffmpeg-resolution2').textContent = '未知';
                    }
                    // 检查右侧码率变化，自动重启ffmpeg_process2
                    if (lastBitrate2 !== null && data.bitrate_2_value !== lastBitrate2) {
                        fetch('http://127.0.0.1:6060/restart_ffmpeg', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ target: 'ffmpeg_process2' })
                        });
                    }
                    lastBitrate2 = data.bitrate_2_value;
                })
                .catch(() => {
                    document.getElementById('device-status1').textContent = '设备通信状态：未知';
                    document.getElementById('ffmpeg-bitrate1').textContent = '未知';
                    document.getElementById('ffmpeg-resolution1').textContent = '未知';
                    document.getElementById('handshake-status2').textContent = '握手状态：未知';
                    document.getElementById('ffmpeg-bitrate2').textContent = '未知';
                    document.getElementById('ffmpeg-resolution2').textContent = '未知';
                });
        }

        function checkAndResetFFmpegRestartCount() {
            fetch('http://127.0.0.1:6060/ffmpeg_restart_count')
                .then(response => response.json())
                .then(data => {
                    // 检查左侧ffmpeg重启计数
                    if (data.ffmpeg_process1_restart_time > 1) {
                        fetch('http://127.0.0.1:6060/reset_ffmpeg_restart_count', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ target: 'ffmpeg_process1' })
                        }).then(() => {
                            // 刷新左侧iframe
                            const iframe1 = document.querySelector('iframe[src*="stream1"]');
                            if (iframe1) iframe1.src = iframe1.src;
                        });
                    }

                    // 检查右侧ffmpeg重启计数
                    if (data.ffmpeg_process2_restart_time > 1) {
                        fetch('http://127.0.0.1:6060/reset_ffmpeg_restart_count', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ target: 'ffmpeg_process2' })
                        }).then(() => {
                            // 刷新右侧iframe
                            const iframe2 = document.querySelector('iframe[src*="stream2"]');
                            if (iframe2) iframe2.src = iframe2.src;
                        });
                    }
                })
                .catch(() => {});
        }

        setInterval(updateFFmpegStatus, 1000);
        setInterval(updateDeviceStatus, 1000);
        setInterval(checkAndResetFFmpegRestartCount, 1000);

        document.addEventListener('DOMContentLoaded', function() {
            updateFFmpegStatus();
            updateDeviceStatus();
            checkAndResetFFmpegRestartCount();
        });
    </script>
</body>
</html>
