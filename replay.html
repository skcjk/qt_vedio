<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>回放文件列表</title>
    <style>
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h2 {
            margin-top: 30px;
        }
        table {
            border-collapse: collapse;
            width: 80%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px 12px;
            text-align: center;
        }
        th {
            background: #f0f0f0;
        }
        .error {
            color: red;
            margin-top: 20px;
        }
        .pagination {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .pagination button {
            margin: 0 5px;
            padding: 4px 12px;
            font-size: 16px;
        }
        .pagination span {
            margin: 0 10px;
        }
        .video-container {
            width: 960px;
            height: 540px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .play-controls {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .play-controls label,
        .play-controls select,
        .play-controls button {
            margin-right: 10px;
            height: 30px;
        }
    </style>
</head>
<body>
    <h2>回放文件列表</h2>
    <div class="video-container">
        <iframe src="http://192.168.137.18:8889/replay/" style="width:960px;height:540px;border:none;"></iframe>
        <div class="play-controls">
            <label for="play-resolution">分辨率:</label>
            <select id="play-resolution" onchange="updatePlayBitrateOptions()">
                <option value="1920x1080">1920x1080(16:9,硬件加速)</option>
                <option value="1280x720">1280x720(16:9,硬件加速)</option>
                <option value="320x180">320x180(16:9,硬件加速)</option>
                <option value="320x240">320x240(4:3,无加速,不推荐)</option>
                <option value="256x144">256x144(16:9,无加速,不推荐)</option>
                <option value="256x128">256x128(2:1,无加速,不推荐)</option>
            </select>
            <label for="play-bitrate">码率:</label>
            <select id="play-bitrate">
                <!-- 码率选项将由JS动态填充 -->
            </select>
            <button id="play-btn">播放</button>
        </div>
    </div>
    <table id="file-table">
        <thead>
            <tr>
                <th></th>
                <th>文件名</th>
                <th>大小 (字节)</th>
                <th>修改时间</th>
            </tr>
        </thead>
        <tbody id="file-tbody">
            <!-- 文件列表将由JS动态填充 -->
        </tbody>
    </table>
    <div class="pagination">
        <button id="prev-page">上一页</button>
        <span id="page-info"></span>
        <button id="next-page">下一页</button>
    </div>
    <div id="error-msg" class="error"></div>
    <script>
        let allFiles = [];
        let currentPage = 1;
        const pageSize = 10;
        let selectedFile = null;

        function renderTable(files) {
            const tbody = document.getElementById('file-tbody');
            tbody.innerHTML = '';
            let lastSelected = selectedFile; // 记录上次选中的文件名
            if (files.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">无文件</td></tr>';
            } else {
                files.forEach((file, idx) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <input type="radio" name="file-select" value="${file.name}">
                        </td>
                        <td>${file.name}</td>
                        <td>${file.size}</td>
                        <td>${file.modified_time}</td>
                    `;
                    tbody.appendChild(tr);
                });
                // 绑定选择事件
                const radios = Array.from(document.getElementsByName('file-select'));
                let checked = false;
                radios.forEach((radio, idx) => {
                    radio.onclick = function() {
                        selectedFile = this.value;
                    };
                    // 自动恢复选中
                    if (radio.value === lastSelected) {
                        radio.checked = true;
                        selectedFile = lastSelected;
                        checked = true;
                    }
                });
                // 默认勾选第一个文件
                if (!checked && radios.length > 0) {
                    radios[0].checked = true;
                    selectedFile = radios[0].value;
                }
            }
        }

        function updatePagination() {
            const totalPages = Math.ceil(allFiles.length / pageSize) || 1;
            document.getElementById('page-info').innerText = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            renderTable(allFiles.slice(start, end));
        }

        function fetchFileList() {
            fetch('http://192.168.137.18:5000/data')
                .then(response => response.json())
                .then(data => {
                    const errorDiv = document.getElementById('error-msg');
                    errorDiv.innerText = '';
                    if (data.status === 'success') {
                        allFiles = data.files || [];
                        if (currentPage > Math.ceil(allFiles.length / pageSize)) {
                            currentPage = 1;
                        }
                        updatePagination();
                    } else {
                        renderTable([]);
                        errorDiv.innerText = data.message || '获取文件列表失败';
                    }
                })
                .catch(err => {
                    renderTable([]);
                    document.getElementById('error-msg').innerText = '网络错误或服务不可用';
                });
        }

        const bitrateOptions = {
            '1920x1080': ['8M', '4M', '原始码流'],
            '1280x720': ['2M', '1M'],
            '320x180': ['80k', '40k'],
            '320x240': ['80k', '40k'],
            '256x144': ['80k', '40k', '20k', '10k'],
            '256x128': ['80k', '40k', '20k', '10k']
        };

        function updatePlayBitrateOptions() {
            const resolution = document.getElementById('play-resolution').value;
            const bitrateSelect = document.getElementById('play-bitrate');
            bitrateSelect.innerHTML = '';
            bitrateOptions[resolution].forEach(bitrate => {
                const option = document.createElement('option');
                option.value = bitrate;
                option.text = bitrate;
                bitrateSelect.add(option);
            });
        }

        // 初始化播放码率选项
        updatePlayBitrateOptions();

        document.getElementById('prev-page').onclick = function() {
            if (currentPage > 1) {
                currentPage--;
                updatePagination();
            }
        };
        document.getElementById('next-page').onclick = function() {
            const totalPages = Math.ceil(allFiles.length / pageSize) || 1;
            if (currentPage < totalPages) {
                currentPage++;
                updatePagination();
            }
        };

        document.getElementById('play-btn').onclick = function() {
            if (!selectedFile) {
                alert('请先选择一个文件');
                return;
            }
            const resolution = document.getElementById('play-resolution').value;
            const bitrate = document.getElementById('play-bitrate').value;
            fetch('http://192.168.137.18:5000/replay', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ filename: selectedFile, resolution, bitrate })
            })
            .then(response => response.json())
            .then(data => {
                // 不显示对话框，直接刷新页面
                location.reload();
            })
            .catch(err => {
                // 网络错误也刷新页面
                location.reload();
            });
        };

        fetchFileList();
        setInterval(fetchFileList, 1000);
    </script>
</body>
</html>
